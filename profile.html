<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="BlockPorter" height="40">
            </a>
            <nav>
                <a href="index.html">Главная</a>
                <a href="dashboard.html">Обмен</a>
                <a href="about.html">О проекте</a>
                <a href="profile.html">Профиль</a>
            </nav>
        </div>
    </header>

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <!-- Нет подключения -->
            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк для просмотра балансов</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить кошелёк
                </button>
            </div>

            <!-- Подключено -->
            <div id="wallet-connected" style="display:none;">
                <div class="network-info">
                    <p>Текущая сеть: <strong id="current-network">Загрузка...</strong></p>
                </div>

                <div class="address-section">
                    <p>Ваш адрес:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <div class="qr-section">
                    <p>QR-код для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <h3>Балансы активов (текущая сеть)</h3>
                <div class="assets-list" id="balances-list"></div>

                <button id="disconnect" class="btn logout-btn">Выйти из кошелька</button>
            </div>
        </div>
    </main>

    <script type="module">
        let currentAccount = null;
        let currentChainId = null;

        const chainNames = {
            '1': 'Ethereum',
            '56': 'BSC',
            '137': 'Polygon',
            '10': 'Optimism',
            '42161': 'Arbitrum'
        };

        const nativeTokens = {
            '1': 'ETH',
            '56': 'BNB',
            '137': 'MATIC',
            '10': 'ETH',
            '42161': 'ETH'
        };

        // Адреса USDC и USDT (6 decimals)
        const stableTokens = {
            USDC: {
                '1': '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
                '56': '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',
                '137': '0x2791bca1f2de4661ed88a30c99a7a9449aa84174',
                '10': '0x7f5c764cbc14f9669b88837ca1490cca17c31607',
                '42161': '0xff970a61a04b1ca14834a43f5de4533ebddb5cc8'
            },
            USDT: {
                '1': '0xdac17f958d2ee523a2206206994597c13d831ec7',
                '56': '0x55d398326f99059ff775485246999027b3197955',
                '137': '0xc2132d05d31c914a87c6611c10748aeb04b58e8f',
                '10': '0x94b008aa00579c1307b0ef2c499ad98a8ce58e58',
                '42161': '0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9'
            }
        };

        // Автозагрузка
        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnected();
            getCurrentChainAndLoad();
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('Установи MetaMask!');
                return;
            }

            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnected();
                getCurrentChainAndLoad();
            } catch (err) {
                alert('Ошибка: ' + err.message);
            }
        }

        async function getCurrentChainAndLoad() {
            const chainHex = await ethereum.request({ method: 'eth_chainId' });
            currentChainId = parseInt(chainHex, 16).toString();
            document.getElementById('current-network').textContent = chainNames[currentChainId] || 'Неизвестная сеть';
            loadBalances();
        }

        function showConnected() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;

            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220, height: 220,
                colorDark: "#00ff9d", colorLight: "#1e1e1e"
            });
        }

        async function loadBalances() {
            const list = document.getElementById('balances-list');
            list.innerHTML = '<div class="asset-row">Загрузка...</div>';

            try {
                // Нативный токен
                const nativeHex = await ethereum.request({ method: 'eth_getBalance', params: [currentAccount, 'latest'] });
                const nativeBalance = parseInt(nativeHex, 16) / 1e18;
                const nativeSymbol = nativeTokens[currentChainId] || 'Native';

                list.innerHTML = `<div class="asset-row"><span>${nativeSymbol}</span><strong>${nativeBalance.toFixed(6)}</strong></div>`;

                // USDC и USDT
                for (const [symbol, contracts] of Object.entries(stableTokens)) {
                    const contract = contracts[currentChainId];
                    if (contract) {
                        const balance = await getTokenBalance(contract);
                        if (balance > 0) {
                            list.innerHTML += `<div class="asset-row"><span>${symbol}</span><strong>${balance.toFixed(6)}</strong></div>`;
                        }
                    }
                }

                if (list.children.length === 1 && list.innerHTML.includes('Загрузка')) {
                    list.innerHTML = '<div class="asset-row">Нет активов в этой сети</div>';
                }
            } catch (e) {
                list.innerHTML = '<div class="asset-row">Ошибка загрузки балансов</div>';
                console.error(e);
            }
        }

        async function getTokenBalance(contract) {
            const data = '0x70a08231000000000000000000000000' + currentAccount.slice(2);
            try {
                const hex = await ethereum.request({ method: 'eth_call', params: [{ to: contract, data }, 'latest'] });
                return parseInt(hex, 16) / 1e6;
            } catch {
                return 0;
            }
        }

        // Смена сети/аккаунта
        if (window.ethereum) {
            ethereum.on('chainChanged', () => location.reload());
            ethereum.on('accountsChanged', () => location.reload());
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('copy-address').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount);
            alert('Адрес скопирован!');
        });
        document.getElementById('disconnect').addEventListener('click', () => {
            localStorage.clear();
            location.reload();
        });
    </script>
</body>
</html>
