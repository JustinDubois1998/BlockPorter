<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="BlockPorter" height="40">
            </a>
            <nav>
                <a href="index.html">Главная</a>
                <a href="dashboard.html">Обмен</a>
                <a href="about.html">О проекте</a>
                <a href="profile.html">Профиль</a>
            </nav>
        </div>
    </header>

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <!-- Если кошелёк не подключён -->
            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк, чтобы увидеть балансы и историю</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить / Войти через кошелёк
                </button>
            </div>

            <!-- После подключения -->
            <div id="wallet-connected" style="display:none;">
                <div class="address-section">
                    <p>Ваш адрес:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <div class="qr-section">
                    <p>QR-код для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <div class="actions">
                    <button id="copy-again" class="btn">Копировать адрес</button>
                </div>

                <h3>Портфель (все цепи и токены)</h3>
                <div class="portfolio-total" id="portfolio-total">
                    Общая стоимость: загрузка...
                </div>

                <div class="assets-list" id="balances-list">
                    <div class="asset-row">Загрузка балансов...</div>
                </div>

                <button id="disconnect" class="btn logout-btn">Выйти из кошелька</button>
            </div>
        </div>
    </main>

    <script type="module">
        let currentAccount = null;

        // Проверка сохранённого подключения
        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnected();
            loadPortfolio();
        }

        // Подключение MetaMask
        async function connectWallet() {
            if (!window.ethereum) {
                alert('MetaMask не установлен! Скачай: https://metamask.io');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnected();
                loadPortfolio();
            } catch (error) {
                if (error.code === 4001) {
                    alert('Подключение отклонено пользователем');
                } else {
                    alert('Ошибка: ' + error.message);
                }
            }
        }

        function showConnected() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;

            // QR-код
            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220,
                height: 220,
                colorDark: "#00ff9d",
                colorLight: "#1e1e1e"
            });
        }

        // Загрузка всего портфеля через DeBank Open API
        async function loadPortfolio() {
            if (!currentAccount) return;

            try {
                const response = await fetch(`https://api.debank.com/user/total_balance?id=${currentAccount}`);
                const data = await response.json();

                const totalBalance = data.data?.total_usd_value || 0;
                document.getElementById('portfolio-total').textContent = 
                    `Общая стоимость портфеля: $${totalBalance.toFixed(2)}`;

                // Все токены
                const tokenResponse = await fetch(`https://api.debank.com/token/balance_list?user_addr=${currentAccount}`);
                const tokenData = await tokenResponse.json();

                const list = document.getElementById('balances-list');
                list.innerHTML = '';

                const tokens = tokenData.data || [];
                if (tokens.length === 0) {
                    list.innerHTML = '<div class="asset-row">Нет активов на подключённом адресе</div>';
                    return;
                }

                // Сортируем по USD стоимости
                tokens.sort((a, b) => (b.amount * b.price || 0) - (a.amount * a.price || 0));

                tokens.forEach(token => {
                    const amount = token.amount?.toFixed(4) || (token.balance / Math.pow(10, token.decimals || 18)).toFixed(4);
                    const usdValue = (token.amount * token.price || token.usd_value || 0).toFixed(2);
                    const chainName = token.chain.charAt(0).toUpperCase() + token.chain.slice(1);

                    list.innerHTML += `
                        <div class="asset-row">
                            <span>${token.symbol} <small>(${chainName})</small></span>
                            <strong>${amount} (≈$${usdValue})</strong>
                        </div>
                    `;
                });

            } catch (error) {
                document.getElementById('balances-list').innerHTML = 
                    '<div class="asset-row">Ошибка загрузки данных DeBank. Попробуйте позже.</div>';
                document.getElementById('portfolio-total').textContent = 'Ошибка загрузки';
                console.error(error);
            }
        }

        // Кнопки
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        document.getElementById('copy-address').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount);
            alert('Адрес скопирован в буфер!');
        });

        document.getElementById('copy-again').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount);
            alert('Адрес скопирован в буфер!');
        });

        document.getElementById('disconnect').addEventListener('click', () => {
            localStorage.removeItem('walletAddress');
            localStorage.removeItem('walletConnected');
            location.reload();
        });

        // Автообновление при смене аккаунта
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
        }
    </script>
</body>
</html>
