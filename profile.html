<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="BlockPorter" height="40">
            </a>
            <nav>
                <a href="index.html">Главная</a>
                <a href="dashboard.html">Обмен</a>
                <a href="about.html">О проекте</a>
                <span id="user-info">Профиль</span>
            </nav>
        </div>
    </header>

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <!-- Нет подключения -->
            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк для просмотра балансов и истории</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить кошелёк
                </button>
            </div>

            <!-- Подключено -->
            <div id="wallet-connected" style="display:none;">
                <!-- Селектор сети -->
                <div class="network-selector">
                    <label>Сеть:</label>
                    <select id="chain-select">
                        <option value="1">Ethereum Mainnet</option>
                        <option value="56">BSC</option>
                        <option value="137">Polygon</option>
                        <option value="42161">Arbitrum</option>
                    </select>
                    <span id="current-network">Текущая: Ethereum</span>
                </div>

                <div class="address-section">
                    <p>Адрес:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <div class="qr-section">
                    <p>QR для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <h3>Балансы</h3>
                <div class="assets-list" id="balances-list">
                    <div class="asset-row"><span>Загрузка...</span></div>
                </div>

                <h3>Последние транзакции</h3>
                <div class="tx-history" id="tx-history">
                    <div class="asset-row"><span>Загрузка истории...</span></div>
                </div>

                <button id="disconnect" class="btn logout-btn">Выйти</button>
            </div>
        </div>
    </main>

    <script type="module">
        let currentAccount = null;
        let currentChainId = '1'; // default Ethereum

        const chainConfigs = {
            '1': { name: 'Ethereum Mainnet', covalentId: 1 },
            '56': { name: 'BSC', covalentId: 56 },
            '137': { name: 'Polygon', covalentId: 137 },
            '42161': { name: 'Arbitrum', covalentId: 42161 }
        };

        const tokenContracts = {
            USDC: { // USDC адреса разные в сетях, но Covalent нормализует
                symbol: 'USDC'
            },
            USDT: {
                symbol: 'USDT'
            }
        };

        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnected();
            loadData();
        }

        async function connectWallet() {
            if (!window.ethereum) return alert('Установи MetaMask!');

            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();
                currentChainId = await ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(currentChainId, 16).toString();

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnected();
                loadData();
            } catch (err) {
                alert('Ошибка: ' + err.message);
            }
        }

        function showConnected() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;

            // QR
            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220, height: 220,
                colorDark: "#00ff9d", colorLight: "#1e1e1e"
            });

            updateNetworkDisplay();
        }

        function updateNetworkDisplay() {
            const name = chainConfigs[currentChainId]?.name || 'Неизвестная';
            document.getElementById('current-network').textContent = `Текущая: ${name}`;
            document.getElementById('chain-select').value = currentChainId;
        }

        async function loadData() {
            if (!currentAccount) return;

            const chain = chainConfigs[currentChainId].covalentId;
            const urlBalances = `https://api.covalenthq.com/v1/${chain}/address/${currentAccount}/balances_v2/?key=ckey_3e89fc4b0a794c2e8e3f1f3e3f8`;
            const urlTx = `https://api.covalenthq.com/v1/${chain}/address/${currentAccount}/transactions_v3/?key=ckey_3e89fc4b0a794c2e8e3f1f3e3f8`;

            // Балансы
            try {
                const res = await fetch(urlBalances);
                const data = await res.json();
                const balancesDiv = document.getElementById('balances-list');
                balancesDiv.innerHTML = '';

                // ETH
                const ethBalance = data.data.items.find(i => i.contract_address === '0x0000000000000000000000000000000000000000');
                const eth = ethBalance ? (ethBalance.balance / 1e18).toFixed(4) : '0';
                balancesDiv.innerHTML += `<div class="asset-row"><span>ETH/${chainConfigs[currentChainId].name}</span><strong>${eth} ETH</strong></div>`;

                // USDC и USDT
                const usdc = data.data.items.find(i => i.contract_ticker_symbol === 'USDC') || { balance: 0 };
                const usdt = data.data.items.find(i => i.contract_ticker_symbol === 'USDT') || { balance: 0 };
                balancesDiv.innerHTML += `<div class="asset-row"><span>USDC</span><strong>${(usdc.balance / 1e6).toFixed(2)}</strong></div>`;
                balancesDiv.innerHTML += `<div class="asset-row"><span>USDT</span><strong>${(usdt.balance / 1e6).toFixed(2)}</strong></div>`;
            } catch (e) {
                document.getElementById('balances-list').innerHTML = '<div class="asset-row"><span>Ошибка загрузки балансов</span></div>';
            }

            // История транзакций
            try {
                const resTx = await fetch(urlTx);
                const dataTx = await resTx.json();
                const txDiv = document.getElementById('tx-history');
                txDiv.innerHTML = '';

                const txs = dataTx.data.items.slice(0, 10);
                if (txs.length === 0) {
                    txDiv.innerHTML = '<div class="asset-row"><span>Нет транзакций</span></div>';
                } else {
                    txs.forEach(tx => {
                        const date = new Date(tx.block_signed_at).toLocaleString('ru-RU');
                        const value = (tx.value / 1e18).toFixed(4);
                        const hashShort = tx.tx_hash.slice(0, 10) + '...';
                        txDiv.innerHTML += `
                            <div class="asset-row tx-row">
                                <div>
                                    <strong>${date}</strong><br>
                                    <a href="https://${chainConfigs[currentChainId].name.toLowerCase()}.etherscan.io/tx/${tx.tx_hash}" target="_blank">${hashShort}</a>
                                </div>
                                <strong>${tx.successful ? '+' : '-'} ${value} ETH</strong>
                            </div>`;
                    });
                }
            } catch (e) {
                document.getElementById('tx-history').innerHTML = '<div class="asset-row"><span>Ошибка загрузки истории</span></div>';
            }
        }

        // Смена сети
        document.getElementById('chain-select').addEventListener('change', async e => {
            const newChain = e.target.value;
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x' + parseInt(newChain).toString(16) }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    alert('Сеть не добавлена в MetaMask');
                }
            }
        });

        // События MetaMask
        if (window.ethereum) {
            ethereum.on('chainChanged', chainId => {
                currentChainId = parseInt(chainId, 16).toString();
                updateNetworkDisplay();
                loadData();
            });
            ethereum.on('accountsChanged', () => location.reload());
        }

        // Кнопки
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('copy-address').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount); alert('Скопировано!');
        });
        document.getElementById('disconnect').addEventListener('click', () => {
            localStorage.clear(); location.reload();
        });
    </script>
</body>
</html>
