<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="BlockPorter" height="40">
            </a>
            <nav>
                <a href="index.html">Главная</a>
                <a href="dashboard.html">Обмен</a>
                <a href="about.html">О проекте</a>
                <span id="user-info">Профиль</span>
            </nav>
        </div>
    </header>

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <!-- Блок без подключения кошелька -->
            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк, чтобы увидеть балансы и QR-код для пополнения</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить / Войти через кошелёк
                </button>
            </div>

            <!-- Блок после подключения -->
            <div id="wallet-connected" style="display:none;">
                <!-- Выбор сети -->
                <div class="network-selector">
                    <label>Сеть:</label>
                    <select id="chain-select">
                        <option value="1">Ethereum</option>
                        <option value="56">Binance Smart Chain</option>
                        <option value="137">Polygon</option>
                        <option value="10">Optimism</option>
                        <option value="42161">Arbitrum</option>
                    </select>
                    <span id="current-network">Текущая: —</span>
                </div>

                <!-- Адрес -->
                <div class="address-section">
                    <p>Ваш адрес кошелька:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <!-- QR-код -->
                <div class="qr-section">
                    <p>QR-код для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <!-- Балансы (парсинг с explorer) -->
                <h3>Балансы активов</h3>
                <div class="assets-list" id="balances-list">
                    <div class="asset-row">Загрузка балансов...</div>
                </div>

                <!-- Кнопки действий и выход -->
                <div class="actions">
                    <button id="copy-again" class="btn">Копировать адрес снова</button>
                </div>

                <button id="disconnect" class="btn logout-btn">Выйти из кошелька</button>
            </div>
        </div>
    </main>

    <script type="module">
        // Поддерживаемые сети и их explorers
        const explorers = {
            '1': { name: 'Ethereum', baseUrl: 'https://etherscan.io/address/' },
            '56': { name: 'Binance Smart Chain', baseUrl: 'https://bscscan.com/address/' },
            '137': { name: 'Polygon', baseUrl: 'https://polygonscan.com/address/' },
            '10': { name: 'Optimism', baseUrl: 'https://optimistic.etherscan.io/address/' },
            '42161': { name: 'Arbitrum', baseUrl: 'https://arbiscan.io/address/' }
        };

        // Бесплатный CORS-proxy (работает стабильно на 2026 год)
        const proxy = 'https://corsproxy.io/?';

        let currentAccount = null;
        let currentChainId = '137'; // По умолчанию Polygon

        // Проверка сохранённого подключения
        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnectedState();
            loadBalancesFromExplorer();
        }

        // Подключение MetaMask
        async function connectWallet() {
            if (!window.ethereum) {
                alert('MetaMask не установлен! Скачай: https://metamask.io');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();

                const chainHex = await window.ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(chainHex, 16).toString();

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnectedState();
                loadBalancesFromExplorer();
            } catch (err) {
                alert('Ошибка подключения: ' + err.message);
            }
        }

        // Показать интерфейс после подключения
        function showConnectedState() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;
            document.getElementById('chain-select').value = currentChainId;

            updateNetworkDisplay();

            // Генерация QR-кода
            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220,
                height: 220,
                colorDark: "#00ff9d",
                colorLight: "#1e1e1e"
            });
        }

        function updateNetworkDisplay() {
            const name = explorers[currentChainId]?.name || 'Неизвестная сеть';
            document.getElementById('current-network').textContent = `Текущая: ${name}`;
        }

        // Парсинг балансов с explorer (без API-ключа)
        async function loadBalancesFromExplorer() {
            if (!currentAccount) return;

            const explorer = explorers[currentChainId];
            if (!explorer) {
                document.getElementById('balances-list').innerHTML = '<div class="asset-row">Сеть не поддерживается для парсинга</div>';
                return;
            }

            const pageUrl = explorer.baseUrl + currentAccount;
            const proxyUrl = proxy + encodeURIComponent(pageUrl);

            document.getElementById('balances-list').innerHTML = '<div class="asset-row">Загрузка балансов...</div>';

            try {
                const response = await fetch(proxyUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const list = document.getElementById('balances-list');
                list.innerHTML = '';

                // Native баланс (ETH / BNB / MATIC / OP)
                let nativeBalance = '0';
                const balanceEl = doc.querySelector('#balance') || 
                                  doc.querySelector('#availableBalance') || 
                                  doc.querySelector('[id*="ContentPlaceHolder1_divSummary"] .listamount') ||
                                  doc.querySelector('.card-body strong');
                if (balanceEl) {
                    nativeBalance = balanceEl.textContent.trim().split(' ')[0];
                }
                const nativeName = currentChainId === '56' ? 'BNB' : 
                                  currentChainId === '137' ? 'MATIC' : 
                                  currentChainId === '10' ? 'OP' : 'ETH';
                list.innerHTML += `<div class="asset-row"><span>${nativeName} (Native)</span><strong>${nativeBalance} ${nativeName}</strong></div>`;

                // Токены ERC-20 (таблица в dropdown "Token")
                const tokenRows = doc.querySelectorAll('#tblResult tbody tr, table#table-token tbody tr');
                tokenRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const tokenSymbol = cells[1]?.textContent.trim().split(' ')[0] || 'Unknown';
                        const balanceText = cells[2]?.textContent.trim() || '0';
                        if (parseFloat(balanceText.replace(/,/g, '')) > 0) {
                            list.innerHTML += `<div class="asset-row"><span>${tokenSymbol}</span><strong>${balanceText}</strong></div>`;
                        }
                    }
                });

                if (list.innerHTML === '') {
                    list.innerHTML = '<div class="asset-row">Нет токенов с балансом > 0</div>';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('balances-list').innerHTML = '<div class="asset-row">Ошибка загрузки (попробуйте позже или смените сеть)</div>';
            }
        }

        // Переключение сети в MetaMask
        document.getElementById('chain-select').addEventListener('change', async (e) => {
            currentChainId = e.target.value;
            updateNetworkDisplay();
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x' + parseInt(currentChainId).toString(16) }]
                });
                loadBalancesFromExplorer();
            } catch (switchError) {
                alert('Не удалось переключить сеть');
            }
        });

        // События MetaMask
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = parseInt(chainId, 16).toString();
                updateNetworkDisplay();
                loadBalancesFromExplorer();
            });
            window.ethereum.on('accountsChanged', () => location.reload());
        }

        // Кнопки
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('copy-address').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount);
            alert('Адрес скопирован в буфер обмена!');
        });
        document.getElementById('copy-again').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount);
            alert('Адрес скопирован в буфер обмена!');
        });
        document.getElementById('disconnect').addEventListener('click', () => {
            localStorage.clear();
            location.reload();
        });
    </script>
</body>
</html>
