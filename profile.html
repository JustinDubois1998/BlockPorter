<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <!-- Тот же header -->

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить кошелёк
                </button>
            </div>

            <div id="wallet-connected" style="display:none;">
                <div class="network-selector">
                    <span id="current-network">Сеть: Загрузка...</span>
                </div>

                <div class="address-section">
                    <p>Адрес:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <div class="qr-section">
                    <p>QR для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <h3>Балансы (все токены)</h3>
                <div class="assets-list" id="balances-list">Загрузка...</div>

                <h3>Последние транзакции</h3>
                <div class="tx-history" id="tx-history">Загрузка...</div>

                <button id="disconnect" class="btn logout-btn">Выйти</button>
            </div>
        </div>
    </main>

    <script type="module">
        // ВСТАВЬ СВОЙ MORALIS API KEY СЮДА!
        const MORALIS_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjQxNmYwZTIyLWU4NzktNGMyYi05NzRkLTlkODA4MjMyY2Q4ZCIsIm9yZ0lkIjoiNDg5MzI2IiwidXNlcklkIjoiNTAzNDU3IiwidHlwZUlkIjoiZmQ1M2E1ZjUtOTIxYi00OTI5LTk2OTItNDcyMDhhMzQ2MzA4IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3Njc5MDU2ODMsImV4cCI6NDkyMzY2NTY4M30.y6UU-cK_dELgx377LsGND73mfSMyup6iDidhJ4sGR1U';

        let currentAccount = null;
        let currentChainId = null;

        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnected();
            loadMoralisData();
        }

        async function connectWallet() {
            if (!window.ethereum) return alert('Установи MetaMask!');

            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();
                const chainHex = await ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(chainHex, 16);

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnected();
                loadMoralisData();
            } catch (err) {
                alert('Ошибка подключения: ' + err.message);
            }
        }

        function showConnected() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;

            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220, height: 220,
                colorDark: "#00ff9d", colorLight: "#1e1e1e"
            });

            document.getElementById('current-network').textContent = `Сеть: ${getChainName(currentChainId)}`;
        }

        function getChainName(id) {
            const names = {1: 'Ethereum', 56: 'BSC', 137: 'Polygon', 10: 'Optimism', 42161: 'Arbitrum'};
            return names[id] || 'Неизвестная';
        }

        async function loadMoralisData() {
            if (!currentAccount || !MORALIS_API_KEY.includes('eyJ')) {
                document.getElementById('balances-list').innerHTML = 'Вставьте Moralis API Key!';
                return;
            }

            const headers = { 'x-api-key': MORALIS_API_KEY, 'accept': 'application/json' };

            // Балансы всех токенов
            try {
                const balRes = await fetch(`https://deep-index.moralis.io/api/v2.2/wallets/balances?chain=0x${currentChainId.toString(16)}&wallet_addresses[]=${currentAccount}`, { headers });
                const balData = await balRes.json();
                const list = document.getElementById('balances-list');
                list.innerHTML = '';
                balData.forEach(token => {
                    if (parseFloat(token.balance_formatted) > 0) {
                        const usd = token.usd_value ? ` (~$${parseFloat(token.usd_value).toFixed(2)})` : '';
                        list.innerHTML += `<div class="asset-row"><span>${token.token_symbol || token.token_name}</span><strong>${token.balance_formatted} ${usd}</strong></div>`;
                    }
                });
            } catch (e) {
                document.getElementById('balances-list').innerHTML = 'Ошибка балансов';
            }

            // История транзакций
            try {
                const txRes = await fetch(`https://deep-index.moralis.io/api/v2.2/wallets/history?chain=0x${currentChainId.toString(16)}&wallet_addresses[]=${currentAccount}&order=DESC`, { headers });
                const txData = await txRes.json();
                const txDiv = document.getElementById('tx-history');
                txDiv.innerHTML = '';
                txData.slice(0, 10).forEach(tx => {
                    const date = new Date(tx.block_timestamp).toLocaleString('ru-RU');
                    const value = tx.value ? (parseInt(tx.value)/1e18).toFixed(4) : '0';
                    txDiv.innerHTML += `<div class="asset-row tx-row"><div><strong>${date}</strong><br>${tx.hash.slice(0,10)}...</div><strong>${value} ${getChainName(currentChainId)}</strong></div>`;
                });
            } catch (e) {
                document.getElementById('tx-history').innerHTML = 'Ошибка истории';
            }
        }

        // События
        if (window.ethereum) {
            ethereum.on('chainChanged', () => location.reload());
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('copy-address').addEventListener('click', () => { navigator.clipboard.writeText(currentAccount); alert('Скопировано!'); });
        document.getElementById('disconnect').addEventListener('click', () => { localStorage.clear(); location.reload(); });
    </script>
</body>
</html>
