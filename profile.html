<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockPorter - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="BlockPorter" height="40">
            </a>
            <nav>
                <a href="index.html">Главная</a>
                <a href="dashboard.html">Обмен</a>
                <a href="about.html">О проекте</a>
                <span id="user-info">Профиль</span>
            </nav>
        </div>
    </header>

    <main class="container profile-main">
        <div class="profile-card">
            <h2>Личный кабинет</h2>

            <div id="no-wallet" class="connect-section">
                <p>Подключите кошелёк для просмотра балансов и истории</p>
                <button id="connect-wallet" class="btn auth-main-btn metamask-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="wallet-icon">
                    Подключить кошелёк
                </button>
            </div>

            <div id="wallet-connected" style="display:none;">
                <div class="network-selector">
                    <label>Сеть:</label>
                    <select id="chain-select">
                        <option value="1">Ethereum</option>
                        <option value="56">BSC</option>
                        <option value="137">Polygon</option>
                        <option value="10">Optimism</option>
                        <option value="42161">Arbitrum</option>
                    </select>
                    <span id="current-network">Текущая: Ethereum</span>
                </div>

                <div class="address-section">
                    <p>Адрес:</p>
                    <div class="address-display">
                        <span id="full-address"></span>
                        <button id="copy-address" class="btn small">Копировать</button>
                    </div>
                </div>

                <div class="qr-section">
                    <p>QR для пополнения</p>
                    <div id="qr-code"></div>
                </div>

                <h3>Балансы (все токены с балансом >0)</h3>
                <div class="assets-list" id="balances-list">
                    <div class="asset-row">Загрузка балансов...</div>
                </div>

                <h3>Последние 10 транзакций</h3>
                <div class="tx-history" id="tx-history">
                    <div class="asset-row">Загрузка истории...</div>
                </div>

                <button id="disconnect" class="btn logout-btn">Выйти</button>
            </div>
        </div>
    </main>

    <script type="module">
        // ВСТАВЬ СВОЙ API-КЛЮЧ СЮДА!!!
        const COVALENT_API_KEY = 'cqt_rQB47K8jQB6yMrqWcjyQ3xtBVG9V'; // <-- Замени на свой из covalenthq.com

        let currentAccount = null;
        let currentChainId = '1';

        const chainConfigs = {
            '1': { name: 'Ethereum', covalentId: '1' },
            '56': { name: 'BSC', covalentId: '56' },
            '137': { name: 'Polygon', covalentId: '137' },
            '10': { name: 'Optimism', covalentId: '10' },
            '42161': { name: 'Arbitrum', covalentId: '42161' }
        };

        if (localStorage.getItem('walletConnected') === 'true') {
            currentAccount = localStorage.getItem('walletAddress');
            showConnected();
            loadData();
        }

        async function connectWallet() {
            if (!window.ethereum) return alert('Установи MetaMask!');

            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0].toLowerCase();
                const chainHex = await ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(chainHex, 16).toString();

                localStorage.setItem('walletAddress', currentAccount);
                localStorage.setItem('walletConnected', 'true');

                showConnected();
                loadData();
            } catch (err) {
                alert('Ошибка: ' + err.message);
            }
        }

        function showConnected() {
            document.getElementById('no-wallet').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('full-address').textContent = currentAccount;
            document.getElementById('chain-select').value = currentChainId;
            updateNetworkDisplay();

            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), {
                text: currentAccount,
                width: 220, height: 220,
                colorDark: "#00ff9d", colorLight: "#1e1e1e"
            });
        }

        function updateNetworkDisplay() {
            const name = chainConfigs[currentChainId]?.name || 'Неизвестная';
            document.getElementById('current-network').textContent = `Текущая: ${name}`;
        }

        async function loadData() {
            if (!currentAccount || !COVALENT_API_KEY || COVALENT_API_KEY.includes('твой_ключ')) {
                document.getElementById('balances-list').innerHTML = '<div class="asset-row">Вставьте свой API-ключ Covalent!</div>';
                document.getElementById('tx-history').innerHTML = '';
                return;
            }

            const chain = chainConfigs[currentChainId].covalentId;
            const base = `https://api.covalenthq.com/v1/${chain}/address/${currentAccount}`;

            // Балансы — все токены с балансом >0 и ценой
            try {
                const res = await fetch(`${base}/balances_v2/?key=${COVALENT_API_KEY}`);
                const data = await res.json();
                const items = data.data.items.filter(i => i.balance > 0 && i.quote);

                items.sort((a, b) => (b.quote || 0) - (a.quote || 0)); // по стоимости USD

                const list = document.getElementById('balances-list');
                list.innerHTML = '';
                items.forEach(token => {
                    const balance = token.type === 'dust' ? token.balance : (token.balance / Math.pow(10, token.contract_decimals)).toFixed(4);
                    const usd = token.quote ? ` (~$${token.quote.toFixed(2)})` : '';
                    list.innerHTML += `<div class="asset-row"><span>${token.contract_ticker_symbol} (${token.contract_name || 'Native'})</span><strong>${balance} ${usd}</strong></div>`;
                });

                if (items.length === 0) list.innerHTML = '<div class="asset-row">Нет токенов с балансом</div>';
            } catch (e) {
                document.getElementById('balances-list').innerHTML = '<div class="asset-row">Ошибка загрузки балансов (проверь ключ)</div>';
            }

            // История транзакций
            try {
                const resTx = await fetch(`${base}/transactions_v3/?key=${COVALENT_API_KEY}`);
                const dataTx = await resTx.json();
                const txDiv = document.getElementById('tx-history');
                txDiv.innerHTML = '';

                const txs = dataTx.data.items.slice(0, 10);
                if (txs.length === 0) {
                    txDiv.innerHTML = '<div class="asset-row">Нет транзакций</div>';
                } else {
                    txs.forEach(tx => {
                        const date = new Date(tx.block_signed_at).toLocaleString('ru-RU');
                        const value = tx.value ? (tx.value / 1e18).toFixed(4) : '0';
                        const hashShort = tx.tx_hash.slice(0, 10) + '...';
                        const explorer = chain === '1' ? 'etherscan.io' : `${chainConfigs[currentChainId].name.toLowerCase().replace(' ', '-')}.etherscan.io`;
                        txDiv.innerHTML += `
                            <div class="asset-row tx-row">
                                <div>
                                    <strong>${date}</strong><br>
                                    <a href="https://${explorer}/tx/${tx.tx_hash}" target="_blank">${hashShort}</a>
                                </div>
                                <strong>${tx.successful ? '' : 'Failed '} ${value} ${chainConfigs[currentChainId].name.split(' ')[0]}</strong>
                            </div>`;
                    });
                }
            } catch (e) {
                document.getElementById('tx-history').innerHTML = '<div class="asset-row">Ошибка загрузки истории</div>';
            }
        }

        // Переключение сети
        document.getElementById('chain-select').addEventListener('change', async e => {
            const newChain = e.target.value;
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x' + parseInt(newChain, 16).toString(16) }]
                });
            } catch (err) {
                alert('Не удалось переключить сеть в MetaMask');
            }
        });

        if (window.ethereum) {
            ethereum.on('chainChanged', chain => {
                currentChainId = parseInt(chain, 16).toString();
                updateNetworkDisplay();
                loadData();
            });
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('copy-address').addEventListener('click', () => {
            navigator.clipboard.writeText(currentAccount); alert('Адрес скопирован!');
        });
        document.getElementById('disconnect').addEventListener('click', () => {
            localStorage.clear(); location.reload();
        });
    </script>
</body>
</html>
